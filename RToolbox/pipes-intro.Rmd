---
title: "Pipelines in R - A Small Introduction"
author: "Thomas Petzoldt"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default", "useR-fonts", "xaringan-themer.css", "tp_xaringan_scrollable.css"]
    seal: false
    lib_dir: libs
    nature:
      beforeInit: "tp_xaringan.js"
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      self_contained: false
      navigation:
        scroll: false  
  html_document:
    toc: yes
    number_sections: yes
    fig.caption: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
  word_document:
    toc: no
  pdf_document:
    toc: no
    number_sections: yes
bibliography: bib.bib
csl: apa
always_allow_html: true
---


class: center, middle, title-slide

<!--
background-image: url("fig/water_tud_r_oer_by.png")
-->
background-image: url("fig/pipeline01-highkey.png")

background-size: cover


<!-- Own title slide / -->

# Pipelines in R - A Small Introduction

#### Thomas Petzoldt

.small[Version `r Sys.Date()`, source code freely available from https://github.com/tpetzoldt/tpetzoldt.github.io/)]


--- 

Use cursor keys for navigation, press .red["O"] for a slide .red[O]verview

<!--
Verbatim code embedding:
https://themockup.blog/posts/2021-08-27-displaying-verbatim-code-chunks-in-xaringan-presentations/
-->

<!--- Setup ------------------------------------------------------------------->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=14, 
                      fig.height=6, dev.args = list(pointsize=20))
library("dplyr")
library("tidyr")
library("lubridate")
library("kableExtra")
library("DiagrammeR")
mypar <- list(las = 1, cex.lab = 1.4, cex.axis=1.4, lwd = 2)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library("xaringanthemer")
style_mono_light(
  title_slide_text_color = "#00305d",
  link_color = "#006ab2"#,
  #white_color = "#FFFFFF"
)
```

```{r xaringanExtra, include=FALSE, warnint=FALSE}
#library("xaringanExtra")
xaringanExtra::use_webcam()
xaringanExtra::use_tile_view()
#xaringanExtra::use_scribble()
#xaringanExtra::use_freezeframe()
#xaringanExtra::use_progress_bar(color = "#0051BA", location = "top")
```

<!-- citations work differently with xaringan compared to @Markdown / -->
```{r, load_refs, include=FALSE, cache=FALSE}
library("RefManageR")
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "authoryear",
           style = "markdown",
           dashed = FALSE)
bib <- ReadBib("./bib.bib", check = FALSE)
```
<!--- End of Setup ------------------------------------------------------------>

---

## An introductory example

Download the file [leaves.csv](https://raw.githubusercontent.com/tpetzoldt/datasets/main/data/leaves.csv), save it to a working directory and then read it with
`read.csv`:


```{r eval=FALSE}
leaves <- read.csv("leaves.csv") 
```

```{r include=FALSE}
filename <- "https://raw.githubusercontent.com/tpetzoldt/datasets/main/data/leaves.csv"
leaves <- read.csv(filename) 
```

As a first step, it is always a good idea to have a look at the data:

.pull-left[
```{r}
knitr::kable(head(leaves))
```
]

.pull-right[
  ![:scale 55%](fig/leaves_measures.png)
]

---

## A boxplot

```{r}
boxplot(width ~ group, data=leaves)
```

---
## Summary statistics

```{r}
summary(leaves)
```

---
## Summary statistics per group

```{r}
aggregate(cbind(length, width, stalk) ~ group, mean, data=leaves)
aggregate(cbind(length, width, stalk) ~ group, sd, data=leaves)
aggregate(cbind(length, width, stalk) ~ group, min, data=leaves)
aggregate(cbind(length, width, stalk) ~ group, max, data=leaves)
```

---
## More streamlined 

.pull-left[
Package **dplyr** contains two very handy functions:
]
.pull-right[
* `group_by`
* `summarize`
]

#### Classical approach 1: separate code lines

```{r, eval=FALSE}
library(dplyr)
leaves_grouped <- group_by(leaves, group)
summarize(leaves_grouped, mean=mean(width), sd=sd(width), 
                          min=min(width), max=max(width))
```

$\ominus$ needs a temporary variable: `leaves_grouped`

#### Classical approach 2: enclose in parentheses

```{r, eval=FALSE}
summarize(group_by(leaves, group), 
        mean=mean(width), sd=sd(width), min=min(width), max=max(width))
```

$\oplus$ no temporary variables necessary <br>
$\ominus$ nested parentheses

---
.pull-left[
## Alternative: Pipeline
]


.pull-right[
![:scale 90%](fig/pipeline-long.jpg)
]

Output of one function is used as<br> "implicit first argument" of the next function.
#### Data only in first function call

```{r, eval=FALSE}
group_by(leaves, group) %>%
summarize(mean=mean(width), sd=sd(width), 
          min=min(width), max=max(width))
```

#### Or, even more streamlined


```{r}
leaves %>%
  group_by(group) %>%
  summarize(mean=mean(width), sd=sd(width), 
            min=min(width), max=max(width))
```



---
### Classical functional style


```{r, eval=FALSE}
group_by(leaves, group)
```  


```{r diag-functional, echo=FALSE, fig.height=2}
grViz("digraph functional {
         graph [rankdir = 'LR', bgcolor='none']
           node [shape = box, penwidth=2, fontname = 'Helvetica']
             'input', 'output'
           node [shape = 'oval']
             'function(arg1, arg2, ...)'
           edge [penwidth=1.5]
              output -> 'function(arg1, arg2, ...)'[dir=back]
           edge [penwidth=0.7, tailport = 'e', headport = 'n', constraint = false, color='tomato']
              'input' -> 'function(arg1, arg2, ...)'
}")
```


### Pipeline style


```{r, eval=FALSE}
leaves %>% group_by(group)
```  


```{r diag-pipeline, echo=FALSE, fig.height=1.5}
grViz("digraph pipes {
         graph [rankdir = 'LR', bgcolor='none']
           node [shape = box, penwidth=2, fontname = 'Helvetica']
             'input', 'output'
           node [shape = 'oval']
             'function(arg2, ...)'
           node [shape=none]
             '\\%>\\%'
           edge [penwidth=1.5]
              input -> '\\%>\\%' -> 'function(arg2, ...)' -> output
}")
```


---


## Summary statistics for all variables

### Copy and paste ?

```{r, eval=FALSE}
leaves %>%
  group_by(group) %>%
  summarize(mean_l=mean(width), sd_l=sd(width), min_l=min(width), max_l=max(width),
            mean_w=mean(width), sd_w=sd(width), min_w=min(width), max_w=max(width),
            mean_s=mean(width), sd_s=sd(width), min_s=min(width), max_s=max(width)
            )
```


# No!


---

## Use long data formats

* Use long format!
* Put data from all 3 variables (`length, width, stalk`) in one column: `value`
* Identifier column for the variables: `name`

.pull-left[
#### Wide format
```{r echo=FALSE}
leaves %>% head(10) %>% knitr::kable()
```
]

.pull-right[
#### Long format
```{r echo=FALSE}
library("tidyr")
leaves %>% pivot_longer(c("length", "width", "stalk")) %>% head(30) %>% knitr::kable()
```
]


---
## Long data format with `pivot_longer`

```{r}
library("tidyr")
leaves %>% pivot_longer(c("length", "width", "stalk"))
```

### Now calculate summary statistics for all groups and variables

```{r}
leaves %>% 
  pivot_longer(c("length", "width", "stalk")) %>%
  group_by(group, name) %>%
  summarize(mean=mean(value), sd=sd(value), min=min(value), max=max(value))
```

---
## Clementine orange data set

![](fig/caliper.jpg)

The data set consists of samples of clementine oranges, measured, weighed and 
consumed in a statistic course.

The data set consists of two tables, one with a long table of the fruits and another one (brands) with some meta data:

```{r}
library("readxl")
brands  <- read_excel("data/clementines_2019.xlsx", "Brands")
fruits  <- read_excel("data/clementines_2019.xlsx", "Fruits") 
```

---
## Database join

```{r}
fruits2 <- left_join(fruits, brands)
boxplot(weight ~ brand, data=fruits2)
```



## `mutate`

Now let's compare the measured weight of our fruits with a "theoretical weight" 
calculated from length and height using the formula of an ellipsoid

$$
V = 4/3 \pi \cdot \rm (length/2)^2 \cdot height/2
$$
```{r}
fruits <-
  fruits %>%
  mutate(V = 0.001 * 4/3 * pi * (width/2)^2 * height/2, index = weight / V)
```

---

```{r}
library(ggplot2)
fruits %>% ggplot(aes(weight, index)) + geom_point()
```

---

```{r}
fruits %>% ggplot(aes(V, weight)) + geom_point() + geom_smooth(method=lm, se=FALSE) + facet_wrap(~brand)
```


---
## `filter` and `select`


---
## `pivot_longer` and `pivot_wider`

---
## `group_by` and `summarize`

---
## `<tidy-select>`

* only a few examples

---
## dplyr pipes and native pipes

* Pipes from package **dplyr**: `%>%` (also called **magrittr**-style pipes)
* Native pipes since R version 4.1: `|>` have some advantages, but are still less popular
* Native and dplyr pipes are mostly compatible, but not by 100%.


---
## Further reading

Start with the [dplyr cheat sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-transformation.pdf):




For more details, see <https://dplyr.tidyverse.org/>.

---

## Acknowledgemt
<br></br><br></br><br></br>
These slides were created with [R](https://www.r-project.org), [RStudio](https://rstudio.com), [rmarkdown](https://rmarkdown.rstudio.com/), [knitr](https://CRAN.R-project.org/package=knitr) and [xaringan](https://github.com/yihui/xaringan).

`r NoCite(bib, "xaringan")`
`r NoCite(bib, c("RCore2022", "RStudio", "R-knitr"))`

---


## References


```{r refs, echo=FALSE, results="asis"}
PrintBibliography(bib)
```

